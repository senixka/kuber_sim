# Генератор трейсов

## Использование

Поместите все файлы шаблонов в директорию `./data_in`.
Запустите генератор:
```sh
python3 generate.py
```
Для каждого шаблонного файла сгенерированный трейс будет находиться в директории `./data_out`.

## Описание формата шаблонна

Для генерации трейса генератору требуется передать файл - шаблон. Каждая строка такого файла должна иметь вид:

`number_of_collapses template_string`, где `template_string` - шаблонная строка, `number_of_collapses` - количество коллапсов шаблонной строки.

Теперь нужно определить, что такое коллапс шаблонной строки. Рассмотрим выражение вида: `$a^b$` - при его коллапсированни, выражение превратиться в целое число, которое будет выбрано случайно из диапазона `[a, b]` с равномерным распределением. Если `a` и `b` оба целые, то случайное число будет выбрано целым. Если среди `a` и `b` есть нецелое (в записи есть точка), то случайное число будет выбрано действительным. Таким образом, в шаблоне строки можно указывать конструкции вида `$a^b$`, и они все одновременно будут коллапсировать, создавая строку со случайными значениями.

Например, следующая строка:`1000 $1^10$,15,key:$-5^5$`, при попадании в генератор раскроется в 1000 строк, некоторые из которых могут иметь вид: `3,15,key:-2`. В директории `./data_in` уже есть пример шаблонного файла, из которого генерируется тестовый трейс.



## CSV формат

Симулятор поддерживает чтение трейса в CSV формате. Каждая строка трейса в CSV формате описывает группу подов. Проще всего объяснить данный формат на примере. Рассмотрим строку вида:

`1;0;3;4;{{<labels>};{10;20;30;40;5;{<workload>};{<selector>};{<tolerations>};{<affinity>}}};{<hpa>};{vpa}
`

В этой строке:
- `1` - время наступления события в трейсе. В данном примере это 1 секунда, считая от начала симуляции.
- `0` - индекс события в enum (в текущей реализации всегда 0, так как описывает группу подов).
- `3` - количество подов в группе. В данном примере группа состоит из 3 подов.
- `4` - через сколько удалить данную группу (если выставить данное значение в 0, группа не будет удаляться). В данном примере - через 4 секунды, после времени наступления события трейса (удаление произойдет на 1 + 4 = 5-ой секунде симуляции).
- `10` - запрос пода к процессору. В примере это 10 единиц.
- `20` - запрос пода к памяти. В примере это 20 единиц.
- `30` - лимит пода по процессору. В примере это 30 единиц.
- `40` - лимит пода по памяти. В примере это 40 единиц.
- `5` - приоритет пода. В примере это 5.
- `<labels>` - срока с описанием меток и их значений для пода. Формат смотрите ниже.
- `<workload>` - срока с описанием модели нагрузки пода. Формат смотрите ниже.
- `<selector>` - срока с описанием селекторов узлов. Формат смотрите ниже.
- `<tolerations>` - срока с описанием Taints & Tolerations части пода. Формат смотрите ниже.
- `<affinity>` - срока с описанием Affinity/Anti-affinity условий. Формат смотрите ниже.
- `<hpa>` - срока с описанием HPA-профиля группы. Формат смотрите ниже.
- `<vpa>` - срока с описанием VPA-профиля группы. Формат смотрите ниже.

-----

### Формат `<labels>`
Сроку `<labels>` в примере, нужно заменять на строку вида:

`key_1:value_1,key_2:value_2`

Количество пар ключ/значение не ограничено, пары должны разделяться запятой. Если подам не нужны метки, просто оставьте сроку `<labels>` пустой.

-----

### Формат `<selector>`
Сроку `<selector>` в примере, нужно заменять на строку вида:

`key_1:value_1,key_2:value_2`

Количество пар ключ/значение не ограничено, пары должны разделяться запятой. Если подам не нужны селекторы, просто оставьте сроку `<selector>` пустой.

-----

### Формат `<tolerations>`

Сроку `<tolerations>` в примере, нужно заменять на строку вида:

`key_1,value_1,0,1;key_2,value_2,0,1`

Параметры toleration внутри разделяются запятой, сами toleration-ы разделяются точкой с запятой. Более подробно, например для первого toleration-а:
- `key_1` - ключ.
- `value_1` - значение.
- `0` - оператор. Может быть либо `0` (Equal), либо `1` (Exists).
- `1` - эффект. Может быть либо `0` (NoSchedule), либо `1` (PreferNoSchedule).

-----

### Формат `<workload>`

Сроку `<workload>` в примере, нужно заменять на одну из строк вида:
- `0;10;20;30` - для описания `Constant` модели нагрузки. Где:
  - `0` - показывает, что это именно `Constant` модель нагрузки.
  - `10` - потребление процессора (параметр `cpu`).
  - `20` - потребление памяти (параметр `memory`).
  - `30` - время работы нагрузки (параметр `duration`).
-----
- `1;10;20` - для описания `ConstantInfinite` модели нагрузки. Где:
  - `1` - показывает, что это именно `ConstantInfinite` модель нагрузки.
  - `10` - потребление процессора (параметр `cpu`).
  - `20` - потребление памяти (параметр `memory`).
-----
- `2;10;20;30;40;50;60` - для описания `BusyBox` модели нагрузки. Где:
  - `2` - показывает, что это именно `BusyBox` модель нагрузки.
  - `10` - нижнее потребление процессора (параметр `cpu_down`).
  - `20` - нижнее потребление памяти (параметр `memory_down`).
  - `30` - нижнее потребление процессора (параметр `cpu_up`).
  - `40` - нижнее потребление памяти (параметр `memory_up`).
  - `50` - время переключения (параметр `shift_time`).
  - `60` - время работы нагрузки (параметр `duration`).
-----
- `3;10;20;30;40;50` - для описания `BusyBoxInfinite` модели нагрузки. Где:
  - `2` - показывает, что это именно `BusyBoxInfinte` модель нагрузки.
  - `10` - нижнее потребление процессора (параметр `cpu_down`).
  - `20` - нижнее потребление памяти (параметр `memory_down`).
  - `30` - нижнее потребление процессора (параметр `cpu_up`).
  - `40` - нижнее потребление памяти (параметр `memory_up`).
  - `50` - время переключения (параметр `shift_time`).

-----

### Формат `<hpa>`
Сроку `<hpa>` в примере, нужно заменять на строку вида:

`1;2;0.3;0.4;1.3;1.4`

В этой строке:
- `1` - задает значение `min_size` группы. В примере это 1 под.
- `2` - задает значение `max_size` группы. В примере это 2 пода.
- `0.3` - задает значение `scale_down_mean_cpu_fraction` группы. В примере это 0.3.
- `0.4` - задает значение `scale_down_mean_memory_fraction` группы. В примере это 0.4.
- `1.3` - задает значение `scale_up_mean_cpu_fraction` группы. В примере это 1.3.
- `1.4` - задает значение `scale_up_mean_memory_fraction` группы. В примере это 1.4.

Если вы не хотите, чтобы группа подов отслеживалась в HPA, просто оставьте строку `<hpa>` пустой.


-----

### Формат `<vpa>`
Сроку `<vpa>` в примере, нужно заменять на строку вида:

`1;2;11;12`

В этой строке:
- `1` - задает значение `min_allowed_cpu` группы. В примере это 1 единица.
- `2` - задает значение `min_allowed_memory` группы. В примере это 2 единицы.
- `11` - задает значение `max_allowed_cpu` группы. В примере это 11 единиц.
- `12` - задает значение `max_allowed_memory` группы. В примере это 12 единиц.

Если вы не хотите, чтобы группа подов отслеживалась в VPA, просто оставьте строку `<vpa>` пустой.

-----
